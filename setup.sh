#!/bin/bash

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# MeuMU Online - Setup Simplificado
# Apenas inicia o backend para acessar o instalador web
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

clear
echo -e "${PURPLE}${BOLD}"
cat << 'EOF'
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                              โ
โ           ๐ฎ MeuMU Online - Setup Rรกpido ๐ฎ                 โ
โ              Season 19-2-3 รpico - v4.0.0                    โ
โ                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
EOF
echo -e "${NC}"
echo ""

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKEND_DIR="${SCRIPT_DIR}/backend-nodejs"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# VERIFICAR ESTRUTURA
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${CYAN}๐ Diretรณrio: ${SCRIPT_DIR}${NC}"
echo ""

if [ ! -d "$BACKEND_DIR" ]; then
    echo -e "${RED}โ Pasta backend-nodejs nรฃo encontrada!${NC}"
    echo ""
    echo -e "${YELLOW}Verifique se vocรช estรก no diretรณrio correto.${NC}"
    exit 1
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# VERIFICAR NODE.JS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${CYAN}๐ Verificando Node.js...${NC}"

if ! command -v node &> /dev/null; then
    echo -e "${RED}โ Node.js nรฃo instalado!${NC}"
    echo ""
    echo -e "${YELLOW}Instale com:${NC}"
    echo -e "${CYAN}curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -${NC}"
    echo -e "${CYAN}sudo apt-get install -y nodejs${NC}"
    exit 1
fi

NODE_VERSION=$(node --version)
echo -e "${GREEN}โ Node.js ${NODE_VERSION}${NC}"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# INSTALAR DEPENDรNCIAS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

cd "$BACKEND_DIR" || exit 1

if [ ! -d "node_modules" ]; then
    echo -e "${CYAN}๐ฆ Instalando dependรชncias...${NC}"
    npm install
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}โ Erro ao instalar dependรชncias!${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}โ Dependรชncias instaladas!${NC}"
    echo ""
else
    echo -e "${GREEN}โ Dependรชncias jรก instaladas${NC}"
    echo ""
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# VERIFICAR PM2
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

if ! command -v pm2 &> /dev/null; then
    echo -e "${YELLOW}โ๏ธ  PM2 nรฃo instalado. Instalando...${NC}"
    sudo npm install -g pm2
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}โ PM2 instalado!${NC}"
    else
        echo -e "${RED}โ Erro ao instalar PM2!${NC}"
        exit 1
    fi
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# LIMPAR PROCESSOS ANTERIORES
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${CYAN}๐ Limpando processos anteriores...${NC}"

pm2 delete meumu-backend 2>/dev/null
pkill -9 node 2>/dev/null
sleep 2

echo -e "${GREEN}โ Processos limpos${NC}"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# INICIAR BACKEND
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${CYAN}๐ Iniciando backend...${NC}"

pm2 start src/server.js --name meumu-backend --instances 1

if [ $? -ne 0 ]; then
    echo -e "${RED}โ Erro ao iniciar backend!${NC}"
    echo ""
    echo -e "${YELLOW}Tente rodar manualmente para ver o erro:${NC}"
    echo -e "${CYAN}cd ${BACKEND_DIR}${NC}"
    echo -e "${CYAN}node src/server.js${NC}"
    exit 1
fi

pm2 save > /dev/null 2>&1

echo -e "${GREEN}โ Backend iniciado!${NC}"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# AGUARDAR INICIALIZAรรO
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${CYAN}โณ Aguardando inicializaรงรฃo (5 segundos)...${NC}"
sleep 5

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# DETECTAR IP
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

SERVER_IP=$(hostname -I | awk '{print $1}')

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SUCESSO!
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo -e "${GREEN}${BOLD}"
cat << 'EOF'
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                              โ
โ              โ BACKEND INICIADO COM SUCESSO! โ             โ
โ                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
EOF
echo -e "${NC}"
echo ""

echo -e "${PURPLE}${BOLD}๐ฏ PRรXIMO PASSO:${NC}"
echo ""
echo -e "${YELLOW}๐ฑ Abra o instalador web no navegador:${NC}"
echo ""
echo -e "${CYAN}${BOLD}   http://${SERVER_IP}:3001/install${NC}"
echo -e "${CYAN}${BOLD}   ou${NC}"
echo -e "${CYAN}${BOLD}   http://seu-dominio.com:3001/install${NC}"
echo ""

echo -e "${PURPLE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

echo -e "${YELLOW}Comandos รบteis:${NC}"
echo -e "  ${CYAN}pm2 status${NC}              - Ver status do backend"
echo -e "  ${CYAN}pm2 logs meumu-backend${NC}  - Ver logs em tempo real"
echo -e "  ${CYAN}pm2 restart meumu-backend${NC} - Reiniciar backend"
echo -e "  ${CYAN}pm2 stop meumu-backend${NC}   - Parar backend"
echo ""

echo -e "${PURPLE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

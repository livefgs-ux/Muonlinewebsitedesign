<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MeuMU Online - Instalador Web</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #0f0c29 0%, #1a1a2e 50%, #16213e 100%);
      color: #ffffff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: rgba(26, 26, 46, 0.8);
      backdrop-filter: blur(10px);
      border: 2px solid #F5A623;
      border-radius: 20px;
      padding: 40px;
      max-width: 700px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8),
                  0 0 40px rgba(245, 166, 35, 0.3);
    }
    
    .logo {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #F5A623;
    }
    
    .logo h1 {
      font-size: 2.5rem;
      color: #F5A623;
      margin-bottom: 10px;
      text-shadow: 0 0 20px rgba(245, 166, 35, 0.5);
    }
    
    .logo p {
      color: rgba(255, 255, 255, 0.7);
      font-size: 1rem;
    }
    
    .step {
      display: none;
      animation: fadeIn 0.5s ease;
    }
    
    .step.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .step-title {
      color: #F5A623;
      font-size: 1.5rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
    }
    
    input, select {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(245, 166, 35, 0.3);
      border-radius: 8px;
      color: #ffffff;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #F5A623;
      background: rgba(255, 255, 255, 0.1);
      box-shadow: 0 0 10px rgba(245, 166, 35, 0.3);
    }
    
    input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }
    
    .btn {
      padding: 14px 28px;
      background: linear-gradient(135deg, #F5A623 0%, #DAA520 100%);
      color: #1a1a2e;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 10px;
      box-shadow: 0 4px 15px rgba(245, 166, 35, 0.4);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 166, 35, 0.6);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(245, 166, 35, 0.3);
      color: #F5A623;
      box-shadow: none;
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 4px 15px rgba(245, 166, 35, 0.2);
    }
    
    .status {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .status.success {
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid rgba(16, 185, 129, 0.6);
      color: #10b981;
    }
    
    .status.error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.6);
      color: #ef4444;
    }
    
    .status.warning {
      background: rgba(245, 158, 11, 0.2);
      border: 1px solid rgba(245, 158, 11, 0.6);
      color: #f59e0b;
    }
    
    .status.info {
      background: rgba(245, 166, 35, 0.2);
      border: 1px solid rgba(245, 166, 35, 0.6);
      color: #F5A623;
    }
    
    .spinner {
      border: 3px solid rgba(245, 166, 35, 0.3);
      border-top: 3px solid #F5A623;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .help-text {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 5px;
    }
    
    .two-cols {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    @media (max-width: 600px) {
      .two-cols {
        grid-template-columns: 1fr;
      }
    }
    
    .log-output {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(245, 166, 35, 0.3);
      border-radius: 8px;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      margin: 15px 0;
    }
    
    .log-line {
      margin-bottom: 5px;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .log-line.success { color: #10b981; }
    .log-line.error { color: #ef4444; }
    .log-line.warning { color: #f59e0b; }
    
    .skip-info {
      background: rgba(245, 166, 35, 0.1);
      border: 1px solid rgba(245, 166, 35, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      font-size: 0.9rem;
    }
    
    .skip-info strong {
      color: #F5A623;
    }
    
    .skip-info code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      color: #F5A623;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <h1>‚öîÔ∏è MeuMU Online</h1>
      <p>Instalador Web - Configura√ß√£o R√°pida</p>
    </div>
    
    <!-- STEP 1: Database MuOnline -->
    <div class="step active" id="step1">
      <h2 class="step-title">üì¶ Database do Servidor MU</h2>
      
      <div class="form-group">
        <label>Host do MySQL/MariaDB</label>
        <input type="text" id="db_host" value="localhost" placeholder="localhost">
        <div class="help-text">Endere√ßo do servidor de banco de dados</div>
      </div>
      
      <div class="two-cols">
        <div class="form-group">
          <label>Porta</label>
          <input type="number" id="db_port" value="3306" placeholder="3306">
        </div>
        
        <div class="form-group">
          <label>Usu√°rio</label>
          <input type="text" id="db_user" value="root" placeholder="root">
        </div>
      </div>
      
      <div class="form-group">
        <label>Senha</label>
        <input type="password" id="db_password" placeholder="Senha do MySQL">
      </div>
      
      <div class="form-group">
        <label>Nome da Database do MU</label>
        <input type="text" id="db_name_mu" value="MuOnline" placeholder="MuOnline">
        <div class="help-text">Database onde est√£o as tabelas do servidor MU (MEMB_INFO, Character, etc)</div>
      </div>
      
      <button class="btn" onclick="testConnectionMU()">Testar Conex√£o</button>
      <button class="btn btn-secondary" onclick="skipMU()">Pular (configurar depois)</button>
      
      <div id="status-mu" style="margin-top: 20px;"></div>
      
      <div class="skip-info" id="skip-info-mu" style="display: none;">
        <strong>‚ÑπÔ∏è Configura√ß√£o Manual:</strong><br>
        Edite o arquivo: <code>/home/meumu.com/public_html/backend-nodejs/.env</code><br>
        Configure as vari√°veis: <code>DB_HOST</code>, <code>DB_USER</code>, <code>DB_PASSWORD</code>, <code>DB_NAME_MUONLINE</code>
      </div>
    </div>
    
    <!-- STEP 2: Database WebMU -->
    <div class="step" id="step2">
      <h2 class="step-title">üåê Database do Website</h2>
      
      <div class="status info">
        <span>‚ÑπÔ∏è</span>
        <div>
          <strong>Database Separada</strong><br>
          O website usa uma database pr√≥pria para not√≠cias, logs, eventos, etc.
        </div>
      </div>
      
      <div class="form-group">
        <label>Nome da Database do Website</label>
        <input type="text" id="db_name_web" value="webmu" placeholder="webmu">
        <div class="help-text">Ser√° criada automaticamente se n√£o existir</div>
      </div>
      
      <div class="form-group">
        <label>
          <input type="checkbox" id="create_web_db" checked style="width: auto; display: inline-block; margin-right: 8px;">
          Criar database automaticamente
        </label>
      </div>
      
      <button class="btn" onclick="testConnectionWEB()">Testar & Criar Database</button>
      <button class="btn btn-secondary" onclick="prevStep()">‚Üê Voltar</button>
      
      <div id="status-web" style="margin-top: 20px;"></div>
    </div>
    
    <!-- STEP 3: JWT Secret -->
    <div class="step" id="step3">
      <h2 class="step-title">üîê Seguran√ßa</h2>
      
      <div class="form-group">
        <label>JWT Secret (Chave de Autentica√ß√£o)</label>
        <input type="text" id="jwt_secret" placeholder="Ser√° gerado automaticamente" readonly>
        <div class="help-text">Chave secreta para assinar tokens JWT (gerada automaticamente)</div>
      </div>
      
      <button class="btn" onclick="generateJWTSecret()">üé≤ Gerar Nova Chave</button>
      
      <div class="form-group" style="margin-top: 20px;">
        <label>Dom√≠nio do Frontend (Opcional)</label>
        <input type="text" id="frontend_url" placeholder="http://meumu.com" value="http://localhost:5173">
        <div class="help-text">URL do seu site (para CORS). Deixe em branco se n√£o souber</div>
      </div>
      
      <button class="btn" onclick="finalizeInstall()" style="margin-top: 20px;">‚úÖ Finalizar Instala√ß√£o</button>
      <button class="btn btn-secondary" onclick="prevStep()" style="margin-top: 10px;">‚Üê Voltar</button>
      
      <div id="status-final" style="margin-top: 20px;"></div>
    </div>
    
    <!-- STEP 4: Conclu√≠do -->
    <div class="step" id="step4">
      <div style="text-align: center;">
        <div style="font-size: 4rem; margin-bottom: 20px;">üéâ</div>
        <h2 class="step-title" style="justify-content: center;">Instala√ß√£o Conclu√≠da!</h2>
        <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 30px;">
          Seu backend est√° configurado e pronto para uso!
        </p>
      </div>
      
      <div class="status success">
        <span>‚úÖ</span>
        <div>
          <strong>Backend Configurado</strong><br>
          Todas as conex√µes foram testadas com sucesso
        </div>
      </div>
      
      <div class="log-output" id="final-log"></div>
      
      <h3 style="margin: 20px 0 15px 0; color: #F5A623;">üöÄ Pr√≥ximos Passos:</h3>
      
      <div class="status info">
        <span>1Ô∏è‚É£</span>
        <div>
          <strong>Reiniciar o Servidor</strong><br>
          Pressione Ctrl+C no terminal e execute: <code style="color: #F5A623;">node check.js</code> ‚Üí Op√ß√£o 4
        </div>
      </div>
      
      <div class="status info">
        <span>2Ô∏è‚É£</span>
        <div>
          <strong>Acessar a API</strong><br>
          API: <code style="color: #F5A623;">http://meumu.com:3001/api</code>
        </div>
      </div>
      
      <div class="status info">
        <span>3Ô∏è‚É£</span>
        <div>
          <strong>Configurar Frontend (Opcional)</strong><br>
          Edite <code style="color: #F5A623;">src/utils/supabase/info.tsx</code> com a URL da API
        </div>
      </div>
      
      <button class="btn" onclick="location.reload()">üîÑ Reinstalar</button>
      <button class="btn btn-secondary" onclick="window.close()" style="margin-top: 10px;">Fechar</button>
    </div>
  </div>
  
  <script>
    let currentStep = 1;
    let installData = {};
    
    // Gerar JWT Secret automaticamente ao carregar
    window.onload = function() {
      generateJWTSecret();
      console.log('‚úÖ Instalador carregado');
      console.log('üìç API Base URL:', window.location.origin);
    };
    
    function showStep(step) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById('step' + step).classList.add('active');
      currentStep = step;
      console.log('üìç Step atual:', step);
    }
    
    function nextStep() {
      if (currentStep < 4) {
        showStep(currentStep + 1);
      }
    }
    
    function prevStep() {
      if (currentStep > 1) {
        showStep(currentStep - 1);
      }
    }
    
    function skipMU() {
      document.getElementById('skip-info-mu').style.display = 'block';
      setTimeout(() => nextStep(), 2000);
    }
    
    function showStatus(elementId, type, message) {
      const el = document.getElementById(elementId);
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è',
        loading: '<div class="spinner"></div>'
      };
      
      el.innerHTML = `
        <div class="status ${type}">
          ${icons[type]}
          <div>${message}</div>
        </div>
      `;
      
      console.log(`[${type.toUpperCase()}] ${message.replace(/<[^>]*>/g, '')}`);
    }
    
    async function testConnectionMU() {
      console.log('üîç Iniciando teste de conex√£o MU...');
      
      const data = {
        type: 'muonline',
        host: document.getElementById('db_host').value,
        port: parseInt(document.getElementById('db_port').value),
        user: document.getElementById('db_user').value,
        password: document.getElementById('db_password').value,
        database: document.getElementById('db_name_mu').value
      };
      
      console.log('üì§ Enviando dados:', {
        ...data,
        password: '***' // N√£o logar senha
      });
      
      showStatus('status-mu', 'loading', 'Testando conex√£o com o banco MuOnline...');
      
      try {
        const url = '/api/install/test-connection';
        console.log('üì° URL:', url);
        
        const response = await fetch(url, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        console.log('üì• Response status:', response.status);
        console.log('üì• Response headers:', [...response.headers.entries()]);
        
        const result = await response.json();
        console.log('üì• Response data:', result);
        
        if (result.success) {
          showStatus('status-mu', 'success', `
            <strong>Conex√£o bem-sucedida!</strong><br>
            Database: ${result.database}<br>
            Tabelas encontradas: ${result.tables?.length || 0}
          `);
          
          installData.dbMU = data;
          
          setTimeout(() => nextStep(), 1500);
        } else {
          showStatus('status-mu', 'error', `
            <strong>Erro na conex√£o</strong><br>
            ${result.error || 'Verifique as credenciais e tente novamente'}
          `);
        }
      } catch (error) {
        console.error('‚ùå Erro ao testar conex√£o:', error);
        showStatus('status-mu', 'error', `
          <strong>Erro ao conectar</strong><br>
          ${error.message}<br><br>
          <small>Verifique o console do navegador (F12) para mais detalhes</small>
        `);
      }
    }
    
    async function testConnectionWEB() {
      console.log('üîç Iniciando teste de conex√£o WEB...');
      
      const data = {
        type: 'webmu',
        host: document.getElementById('db_host').value,
        port: parseInt(document.getElementById('db_port').value),
        user: document.getElementById('db_user').value,
        password: document.getElementById('db_password').value,
        database: document.getElementById('db_name_web').value,
        createIfNotExists: document.getElementById('create_web_db').checked
      };
      
      console.log('üì§ Enviando dados:', {
        ...data,
        password: '***'
      });
      
      showStatus('status-web', 'loading', 'Testando conex√£o e criando database...');
      
      try {
        const response = await fetch('/api/install/test-connection', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        console.log('üì• Response status:', response.status);
        
        const result = await response.json();
        console.log('üì• Response data:', result);
        
        if (result.success) {
          showStatus('status-web', 'success', `
            <strong>Sucesso!</strong><br>
            Database: ${result.database}<br>
            ${result.created ? 'Database criada' : 'Database j√° existia'}<br>
            Tabelas: ${result.tables?.length || 0}
          `);
          
          installData.dbWEB = data;
          
          setTimeout(() => nextStep(), 1500);
        } else {
          showStatus('status-web', 'error', `
            <strong>Erro</strong><br>
            ${result.error || 'Verifique as credenciais'}
          `);
        }
      } catch (error) {
        console.error('‚ùå Erro ao testar conex√£o:', error);
        showStatus('status-web', 'error', `
          <strong>Erro ao conectar</strong><br>
          ${error.message}<br><br>
          <small>Verifique o console (F12)</small>
        `);
      }
    }
    
    function generateJWTSecret() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
      let secret = '';
      for (let i = 0; i < 64; i++) {
        secret += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      document.getElementById('jwt_secret').value = secret;
      console.log('üîë JWT Secret gerado:', secret.length, 'caracteres');
    }
    
    async function finalizeInstall() {
      console.log('üöÄ Finalizando instala√ß√£o...');
      
      const finalData = {
        dbMU: installData.dbMU,
        dbWEB: installData.dbWEB,
        jwtSecret: document.getElementById('jwt_secret').value,
        frontendUrl: document.getElementById('frontend_url').value || 'http://localhost:5173'
      };
      
      console.log('üì§ Dados finais:', {
        ...finalData,
        dbMU: finalData.dbMU ? '‚úì' : '‚úó',
        dbWEB: finalData.dbWEB ? '‚úì' : '‚úó',
        jwtSecret: '***'
      });
      
      showStatus('status-final', 'loading', 'Salvando configura√ß√µes no .env...');
      
      try {
        const response = await fetch('/api/install/finalize', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(finalData)
        });
        
        console.log('üì• Response status:', response.status);
        
        const result = await response.json();
        console.log('üì• Response data:', result);
        
        if (result.success) {
          // Mostrar log
          const logHtml = result.log.map(line => {
            if (line.includes('‚úÖ') || line.includes('sucesso')) {
              return `<div class="log-line success">${line}</div>`;
            } else if (line.includes('‚ùå') || line.includes('erro')) {
              return `<div class="log-line error">${line}</div>`;
            } else if (line.includes('‚ö†Ô∏è')) {
              return `<div class="log-line warning">${line}</div>`;
            } else {
              return `<div class="log-line">${line}</div>`;
            }
          }).join('');
          
          document.getElementById('final-log').innerHTML = logHtml;
          
          showStatus('status-final', 'success', `
            <strong>Instala√ß√£o conclu√≠da!</strong><br>
            Arquivo .env atualizado com sucesso
          `);
          
          setTimeout(() => nextStep(), 2000);
        } else {
          showStatus('status-final', 'error', `
            <strong>Erro ao salvar</strong><br>
            ${result.error || 'Tente novamente'}
          `);
        }
      } catch (error) {
        console.error('‚ùå Erro ao finalizar:', error);
        showStatus('status-final', 'error', `
          <strong>Erro</strong><br>
          ${error.message}<br><br>
          <small>Verifique o console (F12)</small>
        `);
      }
    }
  </script>
</body>
</html>
